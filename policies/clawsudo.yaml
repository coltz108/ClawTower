# ClawTower clawsudo Enforcement Policies
#
# These policies are enforced by clawsudo (the sudo proxy).
# Unlike default.yaml (detection-only), these BLOCK commands.
#
# enforcement: allow  → permit the command
# enforcement: deny   → block the command
# (no enforcement)    → detect only, don't block
#
# ORDER MATTERS: first match wins. Deny rules MUST come before allow rules
# to prevent broad allow patterns from overriding specific deny patterns.

rules:
  # ── Denied Commands (checked FIRST) ────────────────────────────────────────
  - name: "deny-clawtower-tamper"
    description: "Block modifications to ClawTower config and binaries"
    match:
      command_contains:
        - "/etc/clawtower"
        - "/usr/local/bin/clawtower"
        - "/usr/local/bin/clawsudo"
        - "chattr"
        - "auditctl -D"
        - "auditctl -e 0"
        - "apparmor_parser -R"
    action: critical
    enforcement: deny

  - name: "deny-security-service-tamper"
    description: "Block stop/restart/disable of security-critical services"
    match:
      command_contains:
        - "systemctl stop clawtower"
        - "systemctl restart clawtower"
        - "systemctl disable clawtower"
        - "systemctl mask clawtower"
        - "systemctl stop auditd"
        - "systemctl disable auditd"
        - "systemctl mask auditd"
    action: critical
    enforcement: deny

  - name: "deny-firewall-disable"
    match:
      command_contains:
        - "ufw disable"
        - "iptables -F"
        - "iptables --flush"
        - "nft flush"
    action: critical
    enforcement: deny

  - name: "deny-dangerous-rm"
    match:
      command_contains:
        - "rm -rf /etc"
        - "rm -rf /usr"
        - "rm -rf /var"
        - "rm -rf /home"
        - "rm -rf /boot"
        - "rm -rf /"
    action: critical
    enforcement: deny

  - name: "deny-reverse-shell"
    description: "Block reverse shell patterns via sudo"
    match:
      command_contains:
        - "/dev/tcp/"
        - "/dev/udp/"
        - "bash -i"
        - "sh -i"
        - "nc -e"
    action: critical
    enforcement: deny

  # Catch-all: deny raw shell via sudo
  # Agents shouldn't need `sudo bash` — specific commands should be allowlisted above.
  - name: "deny-sudo-shell"
    description: "Block sudo to raw shell (use specific commands instead)"
    match:
      command: ["bash", "sh", "zsh", "dash"]
    action: critical
    enforcement: deny

  # ── Identity / Cognitive File Protection ────────────────────────────────────
  # Block sudo writes to agent identity files. The agent process writes its own
  # working files (MEMORY.md, TOOLS.md, etc.) as the openclaw user without sudo —
  # that's normal and allowed. What's NOT normal is using sudo to overwrite the
  # core identity files or OpenClaw config, which could subvert the agent.
  - name: "deny-identity-file-tamper"
    description: "Block sudo writes to agent identity and config files"
    match:
      command_contains:
        - "SOUL.md"
        - "IDENTITY.md"
        - "AGENTS.md"
        - "USER.md"
        - "/home/openclaw/.openclaw/openclaw.json"
        - "/home/openclaw/.openclaw/config"
    action: critical
    enforcement: deny

  # ── Known Exfiltration Domains via Sudo ────────────────────────────────────
  - name: "deny-exfil-staging-domains"
    description: "Block sudo network commands to known exfil staging services"
    match:
      command_contains:
        - "webhook.site"
        - "ngrok.io"
        - "ngrok-free.app"
        - "requestbin.com"
        - "pipedream.net"
        - "beeceptor.com"
    action: critical
    enforcement: deny

  # ── Enterprise: Deny dangerous file operations via sudo ──────────────────
  - name: "deny-find-exec"
    description: "find with -exec can run arbitrary commands as root"
    match:
      command_contains: ["find "]
    action: critical
    enforcement: deny

  - name: "deny-sed-write-sensitive"
    description: "sed -i to sensitive paths enables config tampering"
    match:
      command_contains: ["sed -i /etc/", "sed -i /var/", "sed -e", "sed -i s/", "sed -i 's/"]
    action: critical
    enforcement: deny

  - name: "deny-tee-sensitive"
    description: "tee to /etc enables arbitrary file writes as root"
    match:
      command_contains: ["tee /etc/", "tee /var/log/", "tee /root/"]
    action: critical
    enforcement: deny

  - name: "deny-chmod-suid"
    description: "chmod +s creates SUID binaries for priv escalation"
    match:
      command_contains: ["chmod +s", "chmod u+s", "chmod 4"]
    action: critical
    enforcement: deny

  - name: "deny-sudoers-write"
    description: "Writing to sudoers grants permanent root access"
    match:
      command_contains: ["sudoers", "visudo"]
    action: critical
    enforcement: deny

  - name: "deny-chattr-non-clawtower"
    description: "chattr on non-ClawTower files could remove protections"
    match:
      command_contains: ["chattr -i", "chattr +i"]
    action: critical
    enforcement: deny

  # ── Allowed Commands (checked AFTER denies) ────────────────────────────────
  - name: "allow-apt"
    match:
      command: ["apt", "apt-get", "dpkg"]
    action: info
    enforcement: allow

  - name: "allow-docker"
    match:
      command: ["docker", "docker-compose"]
    action: info
    enforcement: allow

  - name: "allow-systemctl-readonly"
    description: "Only allow status/query operations via systemctl"
    match:
      command_contains:
        - "systemctl status"
        - "systemctl is-active"
        - "systemctl is-enabled"
        - "systemctl list-units"
        - "systemctl show"
    action: info
    enforcement: allow

  - name: "allow-journalctl"
    match:
      command: ["journalctl"]
    action: info
    enforcement: allow

  - name: "allow-ufw"
    match:
      command: ["ufw"]
    action: info
    enforcement: allow

  # ── Path-Scoped File Operations ─────────────────────────────────────
  - name: "allow-file-ops-tmp"
    description: "Allow file ops only under /tmp and /var/tmp"
    match:
      command_contains:
        - "cp /tmp/"
        - "cp /var/tmp/"
        - "mv /tmp/"
        - "mv /var/tmp/"
        - "rm /tmp/"
        - "rm /var/tmp/"
        - "mkdir /tmp/"
        - "mkdir /var/tmp/"
    action: info
    enforcement: allow

  - name: "allow-file-ops-openclaw-home"
    description: "Allow file ops under openclaw home"
    match:
      command_contains:
        - "cp /home/openclaw/"
        - "mv /home/openclaw/"
        - "chown openclaw"
        - "chmod /home/openclaw/"
        - "mkdir /home/openclaw/"
    action: info
    enforcement: allow

  - name: "allow-cat-read-only"
    description: "Allow cat for reading (no redirect detection at clawsudo level)"
    match:
      command: ["cat"]
    action: info
    enforcement: allow

  - name: "allow-tee-safe-paths"
    description: "Allow tee only to safe staging paths"
    match:
      command_contains:
        - "tee /tmp/"
        - "tee /var/tmp/"
        - "tee /home/openclaw/"
    action: info
    enforcement: allow

  - name: "allow-ip"
    match:
      command: ["ip"]
    action: info
    enforcement: allow
